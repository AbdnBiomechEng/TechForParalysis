## Instructions for setting up optimal control simulations
The model we currently use is das3.osim (which corresponds to the matlab structure model_struct.mat), in the "Model" directory. This has the same degrees of freedom and muscle elements as the original Delft Shoulder and Elbow model (DSEM), with the following changes:
1. The short head of the biceps is represented by one instead of two elements
2. Some of the wrapping objects and muscle contraction parameters have been updated, to ensure muscles operate in the middle of their range for the normal range of motion (from 0.5 to 1.5 of normalised fibre length).  

The optimal control setup includes an additional control variable (besides muscle excitation): normalised tendon elongation, which takes values from -100 (basically -infinity) to 0.06. This ensures that the maximum force that muscles can produce is ~2.25 times their maximum isometric force.

### Initial state

The initial state initial_state.mat (visualised in Opensim using initial_state.mot) was found by running das3_optimize_hang.m, which is a static optimization that aims to minimize muscle effort (weight=1), scapular winging (weight=0.1), and glenohumeral force away from the centre of the glenoid (weight = 0.01). It does not include kinematic tracking, but it is constrained to look for solutions near the DSEM initial position. The initial guess for this optimization was the DSEM initial position, with zero activations and muscle fibres at their optimal length.

Note: This initial state has quite a high activation of the lower part of the serratus anterior and the middle part of pectoralis major (thoracic), to stabilise the scapula and humeral rotation.

### Optimisation parameters

The function runopt.m is used to set up the simulation, in the section "Read in data and set up optimisation parameters". There, we specify:
- The input kinematic data file. Note that different functions are used to read in data from csv files (examples are in the "input_data" folder), mot files generated by Matlab as outputs of previous optimal control simulations, and mot files generated by Opensim as outputs of Opensim simulations such as Inverse Kinematics. Examples are included as comments in runopt.m.
- Which variables to use from the input kinematic data file, as a cell array. An empty array {} means that all variables present in the file should be used.
- Which degrees of freedom to lock (typically the thorax angles). These are locked to the values found in the input kinematic data files, so they do not need to be constant.
- Which model parameter file to use (model_struct.mat)
- Whether the movement starts and ends at rest
- Whether the movement starts and ends at the initial state kinematics
- The initial (nodes) and final (maxnodes) number of nodes for Direct Collocation, and the factor to increase the number of nodes by (factor). For example, if nodes=5, maxnodes=23 and factor=2, we will run simulations with 5, 10 and 20 nodes.
- IPOPT optimisation settings (max number of iterations, optimality and feasbility tolerances)
- The initial guess, with options: "random", "mid", and if none of the above, assumed to be name of file with previous solution. A good choice for the last option is initial_state.mat.
- The weights of the terms in the cost function: Wdata (kinematic tracking), Weffort (minimization of muscle effort), Wscap (scapulo-thoracic gliding plane) and Whum (glenohumeral stability). Wscap and Whum are optional: if they are not included, scapular and humeral stability are hard constraints.
- A csv file with the maximum muscle activations (default: max_act.csv). This is 1 for all muscles, unless we want to simulate muscle weakness.
- The name of the output folder, which will be created if it does not already exist, and the name of the output files, which will be appended with the number of nodes. e.g. if the file name is "participant1", the output files will be called participant1_5, participant1_10, etc.

opt_output_analysis.m can be used to visualise the outputs of the optimal control simulation.

### Strategies
It is sometimes easier to start off by finding a feasible solution (i.e. setting the cost function to zero by setting all weights to zero), and using that as the initial guess for the tracking simulation.

If we are just interested in the position of the hand, we can run an original-model simulation first (i.e. no muscle weakness) using joint angles as inputs, and get the hand position from the output of this simulation. The input kinematic data for subsequent simulations then becomes:

```
data = importfile_mot('originalmodel_5.mot');  % angle data

data_sim = load('originalmodel_5');  % mat file with all the outputs of the simulation, including hand position
data.Hand_position_x = data_sim.Result.hand_pos(1,:)';
data.Hand_position_y = data_sim.Result.hand_pos(2,:)';
data.Hand_position_z = data_sim.Result.hand_pos(3,:)';

% In our input variables we can now include hand position (also pro/supination, to ensure correct hand orientation):
input_variables = {'time','TH_x','TH_y','TH_z','SC_z',PS_y','Hand_position_x','Hand_position_y','Hand_position_z'};
```
